{
    profile: "baremetal",
    compression:"xz",
    packages: [
        "genpack/devel",
        "sys-apps/memtest86-bin",
        "app-admin/sysstat",
        "app-containers/docker","app-containers/docker-compose",
        "genpack/wireless",
        "app-misc/screen",
        "sci-ml/pytorch",
        "app-misc/radeontop",
        "sys-process/nvtop",
        "dev-vcs/git",
        "app-misc/status-beep",
        "genpack/genpack",
        "dev-python/pip","dev-python/pipdeptree",
        "sys-apps/ripgrep",
        "media-gfx/chafa",
        "net-analyzer/zabbix",
        // vLLM stuffs
        "dev-python/aiohttp","dev-python/jsonschema","dev-python/blake3","dev-python/cachetools","dev-python/cbor2","dev-python/httpx","sci-ml/huggingface_hub","sci-ml/tokenizers","dev-python/uvicorn","dev-python/typer","dev-python/dill","dev-python/diskcache","dev-python/distlib","dev-python/distro","dev-python/dnspython","dev-python/filelock","dev-python/fsspec","dev-python/httptools","dev-python/email-validator","dev-python/watchfiles","dev-python/starlette","dev-python/cachecontrol","dev-python/msgspec","dev-python/networkx","dev-python/scipy","media-libs/opencv","dev-python/soundfile","dev-python/yarl","dev-python/py-cpuinfo","dev-python/pycountry","dev-python/python-dotenv","dev-python/python-json-logger","dev-python/python-multipart","dev-build/ninja","dev-python/pyzmq","dev-python/regex","dev-python/jsonschema","sci-ml/safetensors","sci-ml/sentencepiece","dev-python/setproctitle","dev-python/six","dev-python/tqdm","dev-python/pydantic","dev-python/uvloop","dev-python/websockets","dev-python/importlib-metadata",
        "sci-ml/torchvision",
        "sci-ml/accelerate",
        "sci-ml/transformers",
        // compel stuffs
        "dev-python/notebook",
        "dev-python/networkx",
    ],
    accept_keywords: {
        "sys-fs/fatcat": null,
        "sys-apps/memtest86-bin": null,
        // Latest stable kernel for AMD GPUs
        "sys-kernel/gentoo-kernel-bin": null,
        "virtual/dist-kernel": null, // for gentoo-kernel-bin
        "sys-kernel/linux-firmware": null,

        // ROCm and ML stuffs
        "sci-ml/pytorch": null,
        "sci-ml/caffe2": null,
        "sci-libs/aotriton-bin": null,
        "dev-libs/pthreadpool": null,
        "sci-ml/kineto": null,
        "sci-ml/onnx": null,
        "dev-libs/pocketfft": null,
        "sci-ml/FP16": null,
        "dev-libs/dynolog": null,
        "dev-libs/pfs": null,
        "dev-libs/rccl": null,
        "dev-util/hip": null,
        "dev-util/hipify-clang": null,
        "dev-util/hipcc": null,
        "sci-libs/hipBLAS": null,
        "sci-libs/hipBLASLt": null,
        "sci-libs/hipBLAS-common": null,
        "sci-libs/hipCUB": null,
        "sci-libs/hipFFT": null,
        "sci-libs/hipRAND": null,
        "sci-libs/hipSOLVER": null,
        "sci-libs/hipSPARSE": null,
        "sci-libs/rocPRIM": null,
        "sci-libs/rocRAND": null,
        "sci-libs/rocSPARSE": null,
        "sci-libs/rocSOLVER": null,
        "sci-libs/rocThrust": null,
        "sci-libs/rocBLAS": null,
        "sci-libs/rocFFT": null,
        "sci-libs/blis": null,
        "dev-util/roctracer": null,
        "sci-libs/miopen": null,
        "dev-libs/rocm-core": null,
        "dev-build/rocm-cmake": null,
        "dev-util/rocm-smi": null,
        "dev-libs/rocr-runtime": null,
        "dev-libs/roct-thunk-interface": null,
        "dev-libs/rocm-device-libs": null,
        "=dev-util/rocm-smi-6.4.1": null,
        "dev-libs/rocm-comgr": null,
        "dev-util/rocminfo": null,
        "dev-cpp/frugally-deep": null,
        "dev-cpp/functional-plus": null,
        "dev-python/cppheaderparser": null,
        "dev-libs/half": null,
        "sci-libs/lapack": null,
        "dev-util/Tensile": null,
        "sci-ml/huggingface_hub": null,
        "sci-ml/transformers": null, 
        "sci-ml/tokenizers": null,
        "sci-ml/tensorpipe": null,
        "sci-ml/accelerate": null,
        "sci-ml/torchvision": null,
        "dev-libs/rocm-opencl-runtime": null,
        "sci-libs/flexiblas": null,
        "sci-libs/blas-lapack-aux-wrapper": null,
        // vLLM stuffs
        "dev-python/blake3": null,
        "dev-python/typer": null,
        "dev-python/msgspec": null,
        "dev-python/soundfile": null,
        "sci-ml/safetensors": null,
        "sci-ml/sentencepiece": null,
        "sci-ml/hf_xet": null,
        // compel stuffs
        "dev-python/notebook": null,
        "dev-python/jupyterlab": null,
    },
    use: {
        "media-libs/libglvnd": "X",
        "media-gfx/chafa": "webp",
        "net-analyzer/zabbix": "-postgres",
        "sci-libs/rocPRIM": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "dev-util/roctracer": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocRAND": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "dev-libs/rccl": "AMDGPU_TARGETS: gfx1200 gfx1010 -gfx90a -gfx908 -gfx942", // gfx1103
        "sci-libs/hipBLASLt": "benchmark roctracer AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocFFT": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocSPARSE": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocBLAS": "benchmark -hipblaslt AMDGPU_TARGETS: gfx1200 -gfx1103 gfx1010 -gfx90a -gfx908 -gfx942", // hipblaslt causes roc::hipblas-common. gfx1103 causes error
        "sci-libs/hipCUB": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/hipFFT": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/hipRAND": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/miopen": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocThrust": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/rocSOLVER": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/hipSPARSE": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/hipBLAS": "rocsolver AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-libs/hipSOLVER": "AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-ml/caffe2": "rocm distributed memefficient flash AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942", // memefficient pulls sci-libs/aotriton-bin-0.11 that is non-ROCm 7.1 ready dependency so disabled at the moment
        "dev-util/Tensile": "client AMDGPU_TARGETS: gfx1200 gfx1010 gfx1103 -gfx90a -gfx908 -gfx942",
        "sci-ml/transformers": "torch",
        "media-libs/opencv": "python",
        "sci-ml/torchvision": "rocm",
        // compel stuffs
        "dev-python/ipython": "-gui",
        "net-libs/nodejs": "npm",
    },
    license: {
        "sys-kernel/linux-firmware": "linux-fw-redistributable",
        "sys-apps/memtest86-bin": "PassMark-EULA"
    },
    setup_commands: [
        "rm -f /boot/grub/grub.cfg",
        "sed -i 's/^#PrintLastLog yes$/PrintLastLog no/' /etc/ssh/sshd_config",
        "sed -i 's/^\\(session.*\\spam_lastlog\\.so\\s.*\\)$/#\\1/' /etc/pam.d/system-login"
    ],
    users: [
        {
            name: "torch",
            uid: 1000,
            empty_password: true,
            additional_groups: [
                "wheel","video","docker"
            ]
        }
    ],
    services: ["docker", "status-beep"],
    variants: {
        "cuda": {
            packages: ["x11-drivers/nvidia-drivers"],
            accept_keywords: {
                "dev-util/nvidia-cuda-toolkit": null,
                "dev-libs/cudnn": null,
                "sci-ml/cudnn-frontend": null,
                "dev-libs/cutlass": null,
                "x11-drivers/nvidia-drivers": null,
            },
            use: {
                "dev-util/nvidia-cuda-toolkit": "profiler",
                "sci-ml/caffe2": "cuda -rocm distributed memefficient",
                "sci-ml/torchvision": "cuda",
                "dev-libs/cutlass":  "tools",
                "sci-ml/tensorpipe": "cuda",
                "x11-drivers/nvidia-drivers": "-X -tools kernel-open",
            },
            license:{
                "dev-util/nvidia-cuda-toolkit": "NVIDIA-CUDA",
                "dev-libs/cudnn": "NVIDIA-cuDNN",
                "x11-drivers/nvidia-drivers": "NVIDIA-2025"
            },
            env: {
                "sci-ml/caffe2": "torch_cuda.conf",
                "sci-ml/torchvision": "torch_cuda.conf",
            }
        }
    }
}
// pip install --break-system-packages diffusers transformers accelerate compel
